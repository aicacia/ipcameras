var xe=Object.defineProperty;var ve=(t,e,n)=>e in t?xe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var _=(t,e,n)=>ve(t,typeof e!="symbol"?e+"":e,n);import{g as re,l as Ce,a as be}from"./httpAccess.oZ7xIxns.js";import{j as H}from"./scheduler.CgEFyQ-S.js";import{d as ie,w as se}from"./index.Dmtj9H_x.js";const K=se(navigator.language),cn=ie(K,t=>t);function Se(t){K.set(t)}function Ee(){return H(K)}window.addEventListener("languagechange",()=>{Se(navigator.language)});function V(t,e){return t[0]=(e&4278190080)>>24,t[1]=(e&16711680)>>16,t[2]=(e&65280)>>8,t[3]=e&255,t}function Te(t){return t[3]|t[2]<<8|t[1]<<16|t[0]<<24}const S=Math.pow(2,31)-1|0,G={},R={};class U{constructor(e,n){if(e!==G)throw new TypeError("Options can only be created with the some or none functions");this._value=n}static some(e){return C(e)}static none(){return v()}static from(e){return e!=null?C(e):v()}static fromJSON(e){return U.from(e)}isNone(){return this._value===R}isSome(){return!this.isNone()}expect(e){if(this.isSome())return this._value;throw new Error(typeof e=="function"?e():e)}unwrap(){return this.expect("Tried to unwrap value of none Option")}unwrapOr(e){return this.isSome()?this._value:e}unwrapOrElse(e){return this.isSome()?this._value:e()}map(e){return this.isSome()?C(e(this._value)):v()}mapOr(e,n){return this.isSome()?C(e(this._value)):C(n)}mapOrElse(e,n){return this.isSome()?C(e(this._value)):C(n())}flatMap(e){return this.isSome()?e(this._value):v()}flatMapOr(e,n){return this.isSome()?e(this._value):n}flatMapOrElse(e,n){return this.isSome()?e(this._value):n()}and(e){return this.isSome()?e:v()}andThen(e){return this.isSome()?e(this._value):v()}or(e){return this.isNone()?e:this}orElse(e){return this.isNone()?e():this}xor(e){const n=this.isSome(),r=e.isSome();return n&&!r?this:!n&&r?e:v()}filter(e){return this.isSome()&&e(this._value)?this:v()}getOrInsert(e){return this.isNone()&&(this._value=e),this}getOrInsertWith(e){return this.isNone()&&(this._value=e()),this}clear(){return this._value=R,this}take(){if(this.isSome()){const e=this._value;return this._value=R,C(e)}else return v()}from(e){return e!=null?this._value=e:this.clear(),this}replace(e){return this._value=e,this}ifSome(e,n){return this.isSome()?e(this._value):n&&n(),this}ifNone(e,n){return this.isNone()?e():n&&n(this._value),this}toJSON(){return this.unwrapOr(null)}toJS(){return this.unwrapOr(null)}[Symbol.iterator](){return new _e(this._value)}}class _e{constructor(e){this.value=e}next(){if(this.value===R)return{done:!0,value:void 0};{const e=this.value;return this.value=R,{done:!1,value:e}}}}const C=t=>new U(G,t),v=()=>new U(G,R);class p{constructor(e){this._index=0,this._iter=e}[Symbol.iterator](){return this}iter(){return this}next(){return this._iter.next()}nextWithIndex(){const e=this._iter.next();return e.done?e:{value:[e.value,this._index++]}}enumerate(){throw new Error("Enumerate was not imported!")}peekable(){throw new Error("Peekable was not imported!")}forEach(e){throw new Error("ForEach was not imported!")}map(e){throw new Error("Map was not imported!")}merge(e){throw new Error("Merge was not imported!")}concat(e){return this.merge(e)}filter(e){throw new Error("Filter was not imported!")}step(e){throw new Error("Step was not imported!")}skip(e){throw new Error("Skip was not imported!")}take(e){throw new Error("Take was not imported!")}toMap(e,n){throw new Error("ToMap was not imported!")}flatten(e){throw new Error("Flatten was not imported!")}unflatten(e){throw new Error("Unflatten was not imported!")}reverse(){throw new Error("Reverse was not imported!")}count(){return this.reduce(0,e=>e+1)}consume(){let e=this.next();for(;!e.done;)e=this.next();return this}toArray(){return this.reduce([],(e,n)=>(e.push(n),e))}join(e){return this.toArray().join(e)}indexOf(e){let n=this.next(),r=0;for(;!n.done;){if(n.value===e)return r;r++,n=this.next()}return-1}findIndex(e){let n=this.nextWithIndex();for(;!n.done;){const[r,i]=n.value;if(e(r,i))return i;n=this.nextWithIndex()}return-1}find(e){let n=this.nextWithIndex();for(;!n.done;){const[r,i]=n.value;if(e(r,i))return C(r);n=this.nextWithIndex()}return v()}findAll(e){return this.filter(e)}nth(e=0){let n=this.next();for(e<0&&(e=0);!n.done;){if(e--<=0)return C(n.value);n=this.next()}return v()}first(){return this.nth(0)}last(){let e=this.next();for(;!e.done;){const n=this.next();if(n.done)return C(e.value);e=n}return v()}any(e){return this.findIndex(e)!==-1}some(e){return this.any(e)}none(e){return this.findIndex(e)===-1}all(e){let n=this.nextWithIndex();for(;!n.done;){const[r,i]=n.value;if(!e(r,i))return!1;n=this.nextWithIndex()}return!0}reduce(e,n){let r=this.next();for(;!r.done;){const i=r.value;e=n(e,i,this._index-1),r=this.next()}return e}}function F(t){return t!=null?typeof t[Symbol.iterator]=="function"?new p(t[Symbol.iterator]()):typeof t.next=="function"?t instanceof p?t:new p(t):F(typeof t=="object"?Object.entries(t):[t]):F([])}class Ie extends p{constructor(e){super(e)}next(){const e=super.nextWithIndex();return e.done?e:{value:Re(e.value)}}}p.prototype.enumerate=function(){return new Ie(this)};function Re(t){const e=t[0],n=t;return n[0]=t[1],n[1]=e,n}const Ae=t=>t,ke=t=>t;class Oe extends p{constructor(e,n=Ae,r=ke){super(e),this._map=([i,s])=>[n(i,s),r(i,s)]}toObject(){return this.reduce({},(e,n)=>(e[n[0]]=n[1],e))}next(){const e=super.nextWithIndex();return e.done?e:{done:!1,value:this._map(e.value)}}}p.prototype.toMap=function(e,n){return new Oe(this,e,n)};class Pe extends p{constructor(e,n){super(e),this._fn=n}next(){let e=super.nextWithIndex();for(;!e.done;){const[n,r]=e.value;if(this._fn(n,r))return{done:!1,value:n};e=super.nextWithIndex()}return{done:!0,value:void 0}}}p.prototype.filter=function(e){return new Pe(this,e)};class Ne extends p{constructor(e,n){super(e),this._fn=([r,i])=>(n(r,i),r)}next(){const e=super.nextWithIndex();return e.done?e:{done:!1,value:this._fn(e.value)}}}p.prototype.forEach=function(e){return new Ne(this,e)};let De=class extends p{constructor(e,n){super(e),this._fn=n}next(){const e=super.nextWithIndex();if(e.done)return e;{const[n,r]=e.value;return{done:!1,value:this._fn(n,r)}}}};p.prototype.map=function(e){return new De(this,e)};class Me extends p{constructor(e,n){super(e),this._other=n}next(){const e=super.next();return e.done?this._other.next():e}}p.prototype.merge=function(e){return new Me(this,e)};class Fe extends p{constructor(){super(...arguments),this.peeked=[]}unpeekAll(){return this.peeked.length=0,this}unpeek(){return this.peeked.length>0?C(this.peeked.shift()):v()}peek(e=0){if(e<this.peeked.length)return C(this.peeked[e]);{let n=this.peeked.length-e-1,r=super.next();for(;!r.done&&(this.peeked.push(r.value),!(--n<=0));)r=super.next();return r.done?v():C(r.value)}}next(){const e=this.unpeek();if(e.isSome())return{done:!1,value:e.unwrap()};const n=super.next();return n.done?n:{done:!1,value:n.value}}}p.prototype.peekable=function(){return new Fe(this)};class Le extends p{constructor(e){super(e),this.index=0,this.reversed=!1,this.values=[]}next(){if(!this.reversed){let e=super.next();for(;!e.done;)this.values.push(e),e=super.next();this.reversed=!0,this.index=this.values.length}return this.index===0?{done:!0,value:void 0}:(this.index-=1,this.values[this.index])}}p.prototype.reverse=function(){return new Le(this)};class Ue extends p{constructor(e,n){super(e),this._skipped=0,this._skip=(n<=0?0:n)|0}next(){let e=super.next();for(;!e.done;)if(this._skipped<=this._skip)this._skipped+=1,e=super.next();else return e;return{done:!0,value:void 0}}}p.prototype.skip=function(t){return new Ue(this,t)};class qe extends p{constructor(e,n){super(e),this._stepped=0,this._step=n<=0?1:n|0}next(){let e=super.next();for(;!e.done;)if(this._stepped<this._step)this._stepped+=1,e=super.next();else return this._stepped=0,e;return{done:!0,value:void 0}}}p.prototype.step=function(t){return new qe(this,t)};class $e extends p{constructor(e,n){super(e),this._taken=0,this._count=(n<=0?0:n)|0}next(){return this._taken<this._count?(this._taken+=1,super.next()):{done:!0,value:void 0}}}p.prototype.take=function(e){return new $e(this,e)};class We extends p{constructor(e,n){super(e),this._fn=n}next(){return this._fn(this._iter)}}p.prototype.unflatten=function(e){return new We(this,e)};class ze extends p{constructor(e,n=1){super(e),this._current=void 0,this._depth=n}next(){if(this._current!==void 0){const e=this._current.next();if(e.done)this._current=void 0;else return e}return this._nextRecur()}_nextRecur(){const e=super.next();if(e.done)return e;if(this._depth>0){const n=F(e.value).flatten(this._depth-1),r=n.next();return r.done?this._nextRecur():(this._current=n,r)}else return e}}p.prototype.flatten=function(e=1){return new ze(this,e)};class Be extends p{constructor(e){super(e),this.rng=e}iter(){return new p(this)}next(){return{done:!1,value:this.rng.nextFloat()}}}class Je extends p{constructor(e,n=0,r=1){super(e),this.rng=e,this.min=n,this.max=r}iter(){return new p(this)}nextFloat(){return this.rng.nextFloatInRange(this.min,this.max)}next(){return{done:!1,value:this.nextFloat()}}}class He extends p{constructor(e,n=0,r=S){super(e),this.rng=e,this.min=n|0,this.max=r|0}iter(){return new p(this)}nextInt(){return this.rng.nextIntInRange(this.min,this.max)}next(){return{done:!1,value:this.nextInt()}}}const Ke=new Uint8Array(4);class Y{nextFloat(){return this.nextInt()/S}nextFloatInRange(e=0,n=1){return e+this.nextFloat()*(n-e)}nextIntInRange(e=0,n=S){return Math.round(this.nextFloatInRange(e,n))}shuffle(e){const n=e.length;for(let r=0;r<n;r++){const i=r+this.nextIntInRange(0,n-r-1),s=e[r];e[r]=e[i],e[i]=s}return e}fromArray(e){return e.length?C(e[this.nextIntInRange(0,e.length-1)]):v()}keyFromObject(e){return this.fromArray(Object.keys(e))}valueFromObject(e){return this.fromArray(Object.values(e))}fillBytes(e){const n=Ke;for(let r=0,i=e.length;r<i;r++){const s=r%4;s===0&&V(n,this.nextInt()),e[r]=n[s]}return e}[Symbol.iterator](){return this}iter(){return new p(this)}next(){return{done:!1,value:this.nextInt()}}float(){return new Be(this)}uniformFloat(e=0,n=1){return new Je(this,e,n)}uniformInt(e=0,n=S){return new He(this,e,n)}}const oe=typeof crypto<"u"&&typeof crypto.getRandomValues=="function",Ve=new Uint32Array(1),Ge=new Uint8Array(4),ae=oe?()=>crypto.getRandomValues(Ve)[0]%S:()=>Math.random()*S|0,Ye=oe?t=>crypto.getRandomValues(Array.isArray(t)?new Uint8Array(t):t):t=>{const e=Ge;for(let n=0,r=t.length;n<r;n++){const i=n%4;i===0&&V(e,ae()),t[n]=e[i]}return t};class je extends Y{nextInt(){return ae()}fillBytes(e){return Ye(e)}}class ce extends Y{constructor(e=423257940){super(),this.seed=e}setSeed(e=423257940){return this.seed=e,this}nextInt(){return this.seed=Math.imul(48271,this.seed)|0%S,this.seed&S}}const Xe=new ce;class j extends Y{constructor(e,n,r,i){super(),this.x=423257940,this.y=2829571177,this.z=2541948421,this.w=289122235,this.set(e,n,r,i)}static fromSeed(e){return new j().setSeed(e)}setSeed(e){const n=Xe.setSeed(e);return this.set(n.nextInt(),n.nextInt(),n.nextInt(),n.nextInt())}set(e=423257940,n=2829571177,r=2541948421,i=289122235){return this.x=e|0,this.y=n|0,this.z=r|0,this.w=i|0,this}nextInt(){const e=this.x,n=e^e<<11;this.x=this.y,this.y=this.z,this.z=this.w;const r=this.w;return this.w=r^r>>19^(n^n>>8),this.w}}new ce;new j;const Qe=new je;let Ze=Qe;function et(){return Ze.nextFloat()}function hn(){return et()*S|0}function tt(t){return JSON.parse(atob(t.split(".")[1]).toString())}function ue(t,e=!0){return`${e?"https":"http"}://${t}`}function nt(t,e=!0){return`${e?"wss":"ws"}://${t}`}var dn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function rt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function ln(t){if(t.__esModule)return t;var e=t.default;if(typeof e=="function"){var n=function r(){return this instanceof r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};n.prototype=e.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(t).forEach(function(r){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(n,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}),n}var he={exports:{}};(function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function i(h,c,a){this.fn=h,this.context=c,this.once=a||!1}function s(h,c,a,o,d){if(typeof a!="function")throw new TypeError("The listener must be a function");var f=new i(a,o||h,d),l=n?n+c:c;return h._events[l]?h._events[l].fn?h._events[l]=[h._events[l],f]:h._events[l].push(f):(h._events[l]=f,h._eventsCount++),h}function m(h,c){--h._eventsCount===0?h._events=new r:delete h._events[c]}function w(){this._events=new r,this._eventsCount=0}w.prototype.eventNames=function(){var c=[],a,o;if(this._eventsCount===0)return c;for(o in a=this._events)e.call(a,o)&&c.push(n?o.slice(1):o);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(a)):c},w.prototype.listeners=function(c){var a=n?n+c:c,o=this._events[a];if(!o)return[];if(o.fn)return[o.fn];for(var d=0,f=o.length,l=new Array(f);d<f;d++)l[d]=o[d].fn;return l},w.prototype.listenerCount=function(c){var a=n?n+c:c,o=this._events[a];return o?o.fn?1:o.length:0},w.prototype.emit=function(c,a,o,d,f,l){var g=n?n+c:c;if(!this._events[g])return!1;var u=this._events[g],b=arguments.length,T,y;if(u.fn){switch(u.once&&this.removeListener(c,u.fn,void 0,!0),b){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,a),!0;case 3:return u.fn.call(u.context,a,o),!0;case 4:return u.fn.call(u.context,a,o,d),!0;case 5:return u.fn.call(u.context,a,o,d,f),!0;case 6:return u.fn.call(u.context,a,o,d,f,l),!0}for(y=1,T=new Array(b-1);y<b;y++)T[y-1]=arguments[y];u.fn.apply(u.context,T)}else{var ye=u.length,k;for(y=0;y<ye;y++)switch(u[y].once&&this.removeListener(c,u[y].fn,void 0,!0),b){case 1:u[y].fn.call(u[y].context);break;case 2:u[y].fn.call(u[y].context,a);break;case 3:u[y].fn.call(u[y].context,a,o);break;case 4:u[y].fn.call(u[y].context,a,o,d);break;default:if(!T)for(k=1,T=new Array(b-1);k<b;k++)T[k-1]=arguments[k];u[y].fn.apply(u[y].context,T)}}return!0},w.prototype.on=function(c,a,o){return s(this,c,a,o,!1)},w.prototype.once=function(c,a,o){return s(this,c,a,o,!0)},w.prototype.removeListener=function(c,a,o,d){var f=n?n+c:c;if(!this._events[f])return this;if(!a)return m(this,f),this;var l=this._events[f];if(l.fn)l.fn===a&&(!d||l.once)&&(!o||l.context===o)&&m(this,f);else{for(var g=0,u=[],b=l.length;g<b;g++)(l[g].fn!==a||d&&!l[g].once||o&&l[g].context!==o)&&u.push(l[g]);u.length?this._events[f]=u.length===1?u[0]:u:m(this,f)}return this},w.prototype.removeAllListeners=function(c){var a;return c?(a=n?n+c:c,this._events[a]&&m(this,a)):(this._events=new r,this._eventsCount=0),this},w.prototype.off=w.prototype.removeListener,w.prototype.addListener=w.prototype.on,w.prefixed=n,w.EventEmitter=w,t.exports=w})(he);var it=he.exports;const de=rt(it),st="HTTP-WEBRTC",ot="1.0",at=`${st}/${ot}`,ct=6e4,X=13,Q=10;function N(t,e,n){const r=t.encode(n);return le(e,r)}function le(t,e){const n=new Uint8Array(t.length+e.length);return n.set(t),n.set(e,t.length),n}function Z(){return Math.random()*S|0}function ut(t){const e=new Response(t.stream.readable,{status:t.status,statusText:t.statusText,headers:t.headers,duplex:"half"});return Object.defineProperty(e,"url",{value:`webrtc-http:${t.url.pathname}${t.url.search}`}),e}function ht(t){const e=new Map,n=new TextEncoder,r=new TextDecoder;function i(a,o,d,f){const l=new TransformStream,g={connectionId:a,url:new URL(o.url),handled:!1,readStatus:!1,readHeaders:!1,headers:new Headers,status:200,statusText:"",stream:l,writer:l.writable.getWriter(),handle(u,b){if(g.handled){f(new TypeError("Response already handled"));return}g.handled=!0,u?f(u):b?d(b):f(new TypeError("No response"))}};return g.timeoutId=setTimeout(()=>g.handle(new TypeError("Request timed out")),ct),g}function s(a,o,d){let f=Z();for(;e.has(f);)f=Z();const l=i(f,a,o,d);return e.set(f,l),l}async function m(a,o){const d=new URL(o.url),f=V(new Uint8Array(4),a);if(t.send(N(n,f,`${o.method} ${d.pathname+d.search} ${at}`)),o.headers.forEach((l,g)=>{t.send(N(n,f,`${g}: ${l}`))}),t.send(N(n,f,`\r
`)),o.body){const l=o.body.getReader();for(;;){const{done:g,value:u}=await l.read();if(u&&t.send(le(f,u)),g)break}}t.send(N(n,f,`\r
`))}async function w(a,o){const d=e.get(a);if(d)if(d.readStatus)if(d.readHeaders)await d.writer.ready,o[0]===X&&o[1]===Q?(e.delete(a),clearTimeout(d.timeoutId),d.timeoutId=void 0,await d.writer.close()):await d.writer.write(o);else if(o[0]===X&&o[1]===Q)d.readHeaders=!0,d.handle(void 0,ut(d));else{const[f,l]=r.decode(o).split(/\:\s+/);d.headers.append(f,l)}else{d.readStatus=!0;const[f,l,g]=r.decode(o).split(/\s+/,3);d.status=Number.parseInt(l),d.statusText=g}}async function h(a){const o=new Uint8Array(a.data),d=Te(o);await w(d,o.slice(4))}t.addEventListener("message",h);function c(a,o){return new Promise((d,f)=>{const l=new Request(a,o),g=s(l,d,f);m(g.connectionId,l)})}return c.destroy=()=>t.removeEventListener("message",h),c}var x=[];for(var $=0;$<256;++$)x.push(($+256).toString(16).slice(1));function dt(t,e=0){return(x[t[e+0]]+x[t[e+1]]+x[t[e+2]]+x[t[e+3]]+"-"+x[t[e+4]]+x[t[e+5]]+"-"+x[t[e+6]]+x[t[e+7]]+"-"+x[t[e+8]]+x[t[e+9]]+"-"+x[t[e+10]]+x[t[e+11]]+x[t[e+12]]+x[t[e+13]]+x[t[e+14]]+x[t[e+15]]).toLowerCase()}var D,lt=new Uint8Array(16);function ft(){if(!D&&(D=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!D))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return D(lt)}var pt=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const ee={randomUUID:pt};function te(t,e,n){if(ee.randomUUID&&!e&&!t)return ee.randomUUID();t=t||{};var r=t.random||(t.rng||ft)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,dt(r)}const wt=16384,mt={RTCPeerConnection:typeof RTCPeerConnection>"u"?null:RTCPeerConnection,RTCSessionDescription:typeof RTCSessionDescription>"u"?null:RTCSessionDescription,RTCIceCandidate:typeof RTCIceCandidate>"u"?null:RTCIceCandidate};class gt extends de{constructor(e){super(),this.initiator=!1,this.maxChannelMessageSize=wt,this.sdpTransform=yt,this.config={iceServers:[]},this.pendingCandidates=[],this.webrtc=mt,this.id=e.id||te(),this.channelName=e.channelName||te(),e.channelConfig&&(this.channelConfig=e.channelConfig),e.sdpTransform&&(this.sdpTransform=e.sdpTransform),e.config&&(this.config=e.config),e.offerConfig&&(this.offerConfig=e.offerConfig),e.answerConfig&&(this.answerConfig=e.answerConfig),e.maxChannelMessageSize&&e.maxChannelMessageSize>0&&(this.maxChannelMessageSize=e.maxChannelMessageSize),e.webrtc&&(this.webrtc=e.webrtc)}getId(){return this.id}getConnection(){return this.connection}getChannel(){return this.channel}isReady(){return this.channel&&this.channel.readyState==="open"}isClosed(){return!this.connection||this.connection.connectionState!=="connected"}ready(){return this.isReady()?Promise.resolve():this.waitOnce("connect")}isInitiator(){return this.initiator}init(){return this.initiator=!0,this.createPeer()}close(){return this.internalClose(!0)}send(e){if(!this.channel)throw new Error("Channel not initialized");return this.channel.send(e),this}write(e){if(!this.channel)throw new Error("Channel not initialized");return fe(this.channel,e,this.maxChannelMessageSize)}writableStream(){if(!this.channel)throw new Error("Channel not initialized");return xt(this.channel,this.maxChannelMessageSize)}readableStream(){if(!this.channel)throw new Error("Channel not initialized");return vt(this.channel)}async signal(e){var n,r;switch(this.connection||await this.createPeer(),console.debug(`${this.id}: received signal message=${e.type}`),e.type){case"renegotiate":return this.negotiate();case"transceiverRequest":{if(!this.initiator)throw new Error("Invalid signal state");const i=e.transceiverRequest;if(!i)throw new Error("Invalid signal message");return await this.addTransceiverFromKind(i.kind,i.init),this}case"candidate":{if(!this.connection)throw new Error("Connection not initialized");const i=e.candidate;if(!i)throw new Error("Invalid signal message");const s=new this.webrtc.RTCIceCandidate(i);return this.connection.remoteDescription==null?this.pendingCandidates.push(s):await this.connection.addIceCandidate(s),this}case"answer":case"offer":case"pranswer":case"rollback":{if(!this.connection)throw new Error("Connection not initialized");const i=e.sdp;if(!i)throw new Error("Invalid signal message");const s=new this.webrtc.RTCSessionDescription({type:e.type,sdp:i});await this.connection.setRemoteDescription(s);for(const m of this.pendingCandidates)await this.connection.addIceCandidate(m);return this.pendingCandidates.length=0,((r=(n=this.connection)===null||n===void 0?void 0:n.remoteDescription)===null||r===void 0?void 0:r.type)==="offer"&&await this.createAnswer(),this.emit("negotiated"),console.debug(`${this.id}: set remote sdp`),this}default:throw console.debug(`${this.id}: invalid signal type: ${e}`),new Error("Invalid signal message type")}}waitOnce(e){return new Promise(n=>{this.once(e,(...r)=>{switch(r.length){case 0:n(void 0);break;case 1:n(r[0]);break;default:n(r);break}})})}addTransceiverFromKind(e,n){if(!this.connection)throw new Error("Connection not initialized");if(this.initiator){const r=this.connection.addTransceiver(e,n);return this.emit("transceiver",r),r}return this.internalSignal({type:"transceiverRequest",transceiverRequest:{kind:e,init:n}}),null}addTrack(e){if(!this.connection)throw new Error("Connection not initialized");return this.connection.addTrack(e)}removeTrack(e){if(!this.connection)throw new Error("Connection not initialized");return this.connection.removeTrack(e),this}internalSignal(e){return this.emit("signal",e),this}async negotiate(){return this.initiator?await this.createOffer():this.internalSignal({type:"renegotiate",renegotiate:!0}),this}async createOffer(){if(!this.connection)throw new Error("Connection not initialized");const e=await this.connection.createOffer(this.offerConfig);return e.sdp=this.sdpTransform(e.sdp),await this.connection.setLocalDescription(e),this.internalSignal({type:e.type,sdp:e.sdp}),this}async createAnswer(){if(!this.connection)throw new Error("Connection not initialized");const e=await this.connection.createAnswer(this.answerConfig);return e.sdp=this.sdpTransform(e.sdp),await this.connection.setLocalDescription(e),this.internalSignal({type:e.type,sdp:e.sdp}),this}createPeer(){if(this.internalClose(!1),this.connection=new this.webrtc.RTCPeerConnection(this.config),this.connection.addEventListener("negotiationneeded",this.onNegotiationNeeded.bind(this)),this.connection.addEventListener("iceconnectionstatechange",this.onICEConnectionStateChange.bind(this)),this.connection.addEventListener("icegatheringstatechange",this.onICEGatheringStateChange.bind(this)),this.connection.addEventListener("connectionstatechange",this.onConnectionStateChange.bind(this)),this.connection.addEventListener("icecandidate",this.onICECandidate.bind(this)),this.connection.addEventListener("signalingstatechange",this.onSignalingStateChange.bind(this)),this.connection.addEventListener("track",this.onTrackRemote.bind(this)),this.initiator){const e=this.connection.createDataChannel(this.channelName,this.channelConfig);e.addEventListener("open",this.onDataChannelOpen.bind(this)),e.addEventListener("message",this.onDataChannelMessage.bind(this)),e.addEventListener("error",this.onDataChannelError.bind(this)),this.channel=e}else this.connection.addEventListener("datachannel",this.onDataChannel.bind(this));return this}internalClose(e=!0){return this.channel&&(this.channel.close(),this.channel=void 0),this.connection&&(this.connection.close(),this.connection=void 0),e&&this.emit("close"),this}onConnectionStateChange(){if(this.connection)switch(console.debug(`${this.id}: connection state ${this.connection.connectionState}`),this.connection.connectionState){case"failed":case"disconnected":case"closed":this.internalClose(!0);break}}onNegotiationNeeded(){if(this.connection)return this.negotiate()}onICEConnectionStateChange(){this.connection&&console.debug(`${this.id}: ice connection state ${this.connection.iceConnectionState}`)}onICEGatheringStateChange(){this.connection&&console.debug(`${this.id}: ice gathering state ${this.connection.iceGatheringState}`)}onSignalingStateChange(){this.connection&&console.debug(`${this.id}: signaling state ${this.connection.signalingState}`)}onICECandidate(e){e.candidate&&this.internalSignal({type:"candidate",candidate:e.candidate})}onTrackRemote(e){this.emit("track",e)}onDataChannel(e){const n=e.channel;this.channel=n,this.channel.onopen=this.onDataChannelOpen.bind(this),this.channel.onmessage=this.onDataChannelMessage.bind(this),this.channel.onerror=this.onDataChannelError.bind(this)}onDataChannelOpen(){console.debug(`${this.id}: data channel open`),this.emit("connect")}onDataChannelMessage(e){this.emit("data",e.data)}onDataChannelError(e){this.emit("error",new Error("DataChannel error",{cause:e}))}}function yt(t){return t}function fe(t,e,n){if(typeof e=="string")if(e.length<n)t.send(e);else{let r=0;for(;r<e.length;){const i=Math.min(n,e.length-r);t.send(e.substring(r,r+i)),r+=i}}else if(e instanceof Blob)if(e.size<n)t.send(e);else{let r=0;for(;r<e.size;){const i=Math.min(n,e.size-r);t.send(e.slice(r,r+i)),r+=i}}else{let r;if(e instanceof ArrayBuffer?r=e:r=e.buffer,r.byteLength<n)t.send(r);else{let i=0;for(;i<r.byteLength;){const s=Math.min(n,r.byteLength-i);t.send(r.slice(i,i+s)),i+=s}}}}function xt(t,e){return new WritableStream({write(n){fe(t,n,e)}})}function vt(t){let e=!1,n=!1;const r=[],i=[];function s(){return new Promise((h,c)=>i.push([h,c]))}function m(h){if(i.length){const[c,a]=i.shift();c(h.data)}else r.push(h.data)}t.addEventListener("message",m);const w=()=>{if(!e){t.removeEventListener("message",m),t.removeEventListener("close",w),e=!0;for(const[h,c]of i)c(new Error("Stream closed"));i.length=0,r.length=0}};return t.addEventListener("close",w),new ReadableStream({async pull(h){if(e){n||(n=!0,h.close());return}r.length?h.enqueue(r.shift()):h.enqueue(await s())},cancel:w})}class Ct extends de{constructor(e){super(),this.connected=!1,this.connecting=!1,this.reconnecting=!1,this.closed=!1,this.connectTime=Date.now(),this.minTimeBetweenReconnectsMS=0,this.url=e.url,e.WebSocket?this.WebSocket=e.WebSocket:this.WebSocket=WebSocket,e.minTimeBetweenReconnectsMS&&(this.minTimeBetweenReconnectsMS=e.minTimeBetweenReconnectsMS),e.autoconnect&&this.connect()}send(e){var n;if(!this.connected)throw new Error("WebSocket not ready");return(n=this.websocket)===null||n===void 0||n.send(e),this}ready(){return this.connected?Promise.resolve():this.waitOnce("open")}waitOnce(e){return new Promise(n=>{this.once(e,(...r)=>{switch(r.length){case 0:n(void 0);break;case 1:n(r[0]);break;default:n(r);break}})})}close(e,n){this.connected=!1,this.connecting=!1,this.closed=!0,this.websocket?this.websocket.close(e,n):this.emit("close")}async connect(){if(this.connected)return this;if(this.connecting)return this;this.connecting=!0;try{this.connectTime=Date.now();const e=new this.WebSocket(await this.url()),n=()=>{e.removeEventListener("open",n),this.connected=!0,this.emit("open")};e.addEventListener("open",n),e.addEventListener("close",()=>{this.websocket=void 0,this.connected=!1,this.closed?this.emit("close"):(this.emit("disconnect"),this.reconnect())}),e.addEventListener("message",r=>{this.emit("message",r.data)}),e.addEventListener("error",()=>{this.emit("error")}),this.websocket=e}catch(e){this.emit("error",e),this.reconnect()}finally{this.connecting=!1}return this}reconnect(){if(this.reconnecting)return this;this.reconnecting=!0;try{const e=Date.now()-this.connectTime;e<this.minTimeBetweenReconnectsMS?setTimeout(()=>{this.connect()},this.minTimeBetweenReconnectsMS-e):this.connect()}finally{this.reconnecting=!1}return this}}const J=new Map,O=new Ct({url:Et});O.on("message",t=>{const e=JSON.parse(t),n=J.get(e.peerId);n&&n.signal(e.message)});let M;function bt(){if(M)return M;{let t;return M=(e,n)=>{if(!t){const r=St("webrtchttp");t=r.ready().then(()=>(console.debug(`${r.getId()}: ready`),ht(r.getChannel()))),r.on("close",()=>{t=void 0})}return t.then(r=>r(e,n))},M}}function St(t){O.connect();const e=new gt({config:{iceServers:[{urls:["stun:stun.l.google.com:19302"]}]},channelConfig:{ordered:!0}});return e.on("error",n=>console.error(n)),e.on("signal",n=>{O.send(JSON.stringify({type:"signal",peerId:e.getId(),message:n}))}),O.ready().then(()=>{O.send(JSON.stringify({type:"init",peerId:e.getId(),peerType:t}))}),e.on("close",()=>{J.delete(e.getId())}),J.set(e.getId(),e),e}async function Et(){const t=re();if(!t)throw new Error("No remote access configured");const e=await Tt(t);return`${nt(t.host,t.ssl)}/client/websocket?token=${e}`}let W,z;async function Tt(t){return(!z||z<=Date.now())&&(W=await _t(t),z=tt(W).exp*1e3),W}async function _t(t){const e={id:t.id,password:t.password},n={"Content-Type":"application/json"},r=await fetch(`${ue(t.host,t.ssl)}/client`,{method:"POST",headers:n,credentials:"same-origin",mode:"cors",body:JSON.stringify(e)});if(r.status>=400)throw new Error("failed to authenticate");return await r.text()}const It=Ce("access","http");function ne(){return H(It)}const Rt="America/New_York",pe=se(Ot());ie(pe,t=>t);function At(){return H(pe)}function kt(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch{return}}function Ot(){return kt()||Rt}const Pt="http://localhost:3000".replace(/\/+$/,"");class we{constructor(e={}){this.configuration=e}set config(e){this.configuration=e}get basePath(){return this.configuration.basePath!=null?this.configuration.basePath:Pt}get fetchApi(){return this.configuration.fetchApi}get middleware(){return this.configuration.middleware||[]}get queryParamsStringify(){return this.configuration.queryParamsStringify||me}get username(){return this.configuration.username}get password(){return this.configuration.password}get apiKey(){const e=this.configuration.apiKey;if(e)return typeof e=="function"?e:()=>e}get accessToken(){const e=this.configuration.accessToken;if(e)return typeof e=="function"?e:async()=>e}get headers(){return this.configuration.headers}get credentials(){return this.configuration.credentials}}const Nt=new we,L=class L{constructor(e=Nt){_(this,"middleware");_(this,"fetchApi",async(e,n)=>{let r={url:e,init:n};for(const s of this.middleware)s.pre&&(r=await s.pre({fetch:this.fetchApi,...r})||r);let i;try{i=await(this.configuration.fetchApi||fetch)(r.url,r.init)}catch(s){for(const m of this.middleware)m.onError&&(i=await m.onError({fetch:this.fetchApi,url:r.url,init:r.init,error:s,response:i?i.clone():void 0})||i);if(i===void 0)throw s instanceof Error?new Lt(s,"The request failed and the interceptors did not return an alternative response"):s}for(const s of this.middleware)s.post&&(i=await s.post({fetch:this.fetchApi,url:r.url,init:r.init,response:i.clone()})||i);return i});this.configuration=e,this.middleware=e.middleware}withMiddleware(...e){const n=this.clone();return n.middleware=n.middleware.concat(...e),n}withPreMiddleware(...e){const n=e.map(r=>({pre:r}));return this.withMiddleware(...n)}withPostMiddleware(...e){const n=e.map(r=>({post:r}));return this.withMiddleware(...n)}isJsonMime(e){return e?L.jsonRegex.test(e):!1}async request(e,n){const{url:r,init:i}=await this.createFetchParams(e,n),s=await this.fetchApi(r,i);if(s&&s.status>=200&&s.status<300)return s;throw new Ft(s,"Response returned an error code")}async createFetchParams(e,n){let r=this.configuration.basePath+e.path;e.query!==void 0&&Object.keys(e.query).length!==0&&(r+="?"+this.configuration.queryParamsStringify(e.query));const i=Object.assign({},this.configuration.headers,e.headers);Object.keys(i).forEach(a=>i[a]===void 0?delete i[a]:{});const s=typeof n=="function"?n:async()=>n,m={method:e.method,headers:i,body:e.body,credentials:this.configuration.credentials},w={...m,...await s({init:m,context:e})};let h;Mt(w.body)||w.body instanceof URLSearchParams||Dt(w.body)?h=w.body:this.isJsonMime(i["Content-Type"])?h=JSON.stringify(w.body):h=w.body;const c={...w,body:h};return{url:r,init:c}}clone(){const e=this.constructor,n=new e(this.configuration);return n.middleware=this.middleware.slice(),n}};_(L,"jsonRegex",new RegExp("^(:?application/json|[^;/ 	]+/[^;/ 	]+[+]json)[ 	]*(:?;.*)?$","i"));let A=L;function Dt(t){return typeof Blob<"u"&&t instanceof Blob}function Mt(t){return typeof FormData<"u"&&t instanceof FormData}class Ft extends Error{constructor(n,r){super(r);_(this,"name","ResponseError");this.response=n}}class Lt extends Error{constructor(n,r){super(r);_(this,"name","FetchError");this.cause=n}}class P extends Error{constructor(n,r){super(r);_(this,"name","RequiredError");this.field=n}}function me(t,e=""){return Object.keys(t).map(n=>ge(n,t[n],e)).filter(n=>n.length>0).join("&")}function ge(t,e,n=""){const r=n+(n.length?`[${t}]`:t);if(e instanceof Array){const i=e.map(s=>encodeURIComponent(String(s))).join(`&${encodeURIComponent(r)}=`);return`${encodeURIComponent(r)}=${i}`}if(e instanceof Set){const i=Array.from(e);return ge(t,i,n)}return e instanceof Date?`${encodeURIComponent(r)}=${encodeURIComponent(e.toISOString())}`:e instanceof Object?me(e,r):`${encodeURIComponent(r)}=${encodeURIComponent(String(e))}`}class E{constructor(e,n=r=>r){this.raw=e,this.transformer=n}async value(){return this.transformer(await this.raw.json())}}class Ut{constructor(e){this.raw=e}async value(){}}function B(t){return qt(t)}function qt(t,e){return t==null?t:{createdAt:t.createdAt==null?void 0:new Date(t.createdAt),discovered:t.discovered,hardwareId:t.hardwareId,mediaUris:t.mediaUris,name:t.name,record:t.record,recordWindow:t.recordWindow==null?void 0:t.recordWindow,saved:t.saved,updatedAt:new Date(t.updatedAt)}}function $t(t){return t==null?t:{password:t.password,username:t.username}}function Wt(t){return zt(t)}function zt(t,e){return t==null?t:{date:new Date(t.date)}}function Bt(t){return Jt(t)}function Jt(t,e){return t==null?t:{host:t.host,id:t.id,password:t.password,ssl:t.ssl}}function Ht(t){return t==null?t:{password:t.password,passwordConfirmation:t.passwordConfirmation}}function Kt(t){return Vt(t)}function Vt(t,e){return t==null?t:{accessToken:t.accessToken,expiresIn:t.expiresIn,issuedTokenType:t.issuedTokenType,refreshToken:t.refreshToken,refreshTokenExpiresIn:t.refreshTokenExpiresIn,tokenType:t.tokenType}}function Gt(t){return Yt(t)}function Yt(t,e){return t==null?t:{createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt),username:t.username}}function jt(t){return Xt(t)}function Xt(t,e){return t==null?t:{build:t.build,version:t.version}}class Qt extends A{async healthCheckRaw(e){const n={},r={},i=await this.request({path:"/health",method:"GET",headers:r,query:n},e);return new E(i,s=>Wt(s))}async healthCheck(e){return await(await this.healthCheckRaw(e)).value()}async p2pAccessRaw(e){const n={},r={};this.configuration&&this.configuration.apiKey&&(r.Authorization=await this.configuration.apiKey("Authorization"));const i=await this.request({path:"/p2p-access",method:"GET",headers:r,query:n},e);return new E(i,s=>Bt(s))}async p2pAccess(e){return await(await this.p2pAccessRaw(e)).value()}async versionRaw(e){const n={},r={},i=await this.request({path:"/version",method:"GET",headers:r,query:n},e);return new E(i,s=>jt(s))}async version(e){return await(await this.versionRaw(e)).value()}}class Zt extends A{async cameraByHardwareIdRaw(e,n){if(e.hardwareId==null)throw new P("hardwareId",'Required parameter "hardwareId" was null or undefined when calling cameraByHardwareId().');const r={},i={};this.configuration&&this.configuration.apiKey&&(i.Authorization=await this.configuration.apiKey("Authorization"));const s=await this.request({path:"/cameras/{hardwareId}".replace("{hardwareId}",encodeURIComponent(String(e.hardwareId))),method:"GET",headers:i,query:r},n);return new E(s,m=>B(m))}async cameraByHardwareId(e,n){return await(await this.cameraByHardwareIdRaw({hardwareId:e},n)).value()}async camerasRaw(e){const n={},r={};this.configuration&&this.configuration.apiKey&&(r.Authorization=await this.configuration.apiKey("Authorization"));const i=await this.request({path:"/cameras",method:"GET",headers:r,query:n},e);return new E(i,s=>s.map(B))}async cameras(e){return await(await this.camerasRaw(e)).value()}async updateCameraByHardwareIdRaw(e,n){if(e.hardwareId==null)throw new P("hardwareId",'Required parameter "hardwareId" was null or undefined when calling updateCameraByHardwareId().');if(e.updates==null)throw new P("updates",'Required parameter "updates" was null or undefined when calling updateCameraByHardwareId().');const r={},i={};i["Content-Type"]="application/json",this.configuration&&this.configuration.apiKey&&(i.Authorization=await this.configuration.apiKey("Authorization"));const s=await this.request({path:"/cameras/{hardwareId}".replace("{hardwareId}",encodeURIComponent(String(e.hardwareId))),method:"PATCH",headers:i,query:r,body:e.updates},n);return new E(s,m=>B(m))}async updateCameraByHardwareId(e,n,r){return await(await this.updateCameraByHardwareIdRaw({hardwareId:e,updates:n},r)).value()}}class en extends A{async currentUserRaw(e){const n={},r={};this.configuration&&this.configuration.apiKey&&(r.Authorization=await this.configuration.apiKey("Authorization"));const i=await this.request({path:"/user",method:"GET",headers:r,query:n},e);return new E(i,s=>Gt(s))}async currentUser(e){return await(await this.currentUserRaw(e)).value()}async resetPasswordRaw(e,n){if(e.resetPassword==null)throw new P("resetPassword",'Required parameter "resetPassword" was null or undefined when calling resetPassword().');const r={},i={};i["Content-Type"]="application/json",this.configuration&&this.configuration.apiKey&&(i.Authorization=await this.configuration.apiKey("Authorization"));const s=await this.request({path:"/user/reset-password",method:"PATCH",headers:i,query:r,body:Ht(e.resetPassword)},n);return new Ut(s)}async resetPassword(e,n){await this.resetPasswordRaw({resetPassword:e},n)}}class tn extends A{async tokenRaw(e,n){if(e.credentials==null)throw new P("credentials",'Required parameter "credentials" was null or undefined when calling token().');const r={},i={};i["Content-Type"]="application/json";const s=await this.request({path:"/token",method:"POST",headers:i,query:r,body:$t(e.credentials)},n);return new E(s,m=>Kt(m))}async token(e,n){return await(await this.tokenRaw({credentials:e},n)).value()}}let I;const nn={middleware:[{pre:async t=>({...t,init:{...t.init,mode:"cors"}})}],apiKey(t){switch(t){case"X-Timezone":return At();case"X-Locale":return Ee();case"Authorization":return`${I==null?void 0:I.tokenType} ${I==null?void 0:I.accessToken}`;default:return""}},credentials:"same-origin",get fetchApi(){return ne()==="p2p"&&re()?bt():fetch},get basePath(){if(ne()==="http"){const e=be();if(e)return ue(e.host,e.ssl)}return""}},q=new we(nn),fn=new tn(q),pn=new en(q);new Qt(q);const wn=new Zt(q);function mn(t){I=t}export{Qt as A,we as C,de as E,Ft as R,pn as a,_t as b,hn as c,nn as d,It as e,wn as f,ue as g,St as h,q as i,ln as j,dn as k,cn as l,rt as m,mn as s,fn as t};
